<!--
 https://github.com/stevenrskelton/d3-datamaps
-->

<script src="js/d3/d3.v3.min.js"></script>
<script src="js/topojson/topojson.v1.min.js"></script>
<script src="js/datamaps/datamaps.js"></script>

<polymer-element name="d3-datamaps" attributes="selected data hover clicked map theme multiselect zoom">
  <template>
	<style>
		:host { display: block; }
	</style>
    <div id="container" style="position:relative;"></div>
  </template>
  <script>

	var defaultTheme = {
		defaultFill: '#ABDDA4',
		backgroundColor: 'transparent',
		borderWidth: 1,
		borderColor: '#FDFDFD',
		highlightFillColor: '#FC8D59',
		highlightBorderColor: 'rgba(250, 15, 160, 0.2)',
		highlightBorderWidth: 2,
		cursor: 'pointer'
	};
	
	function reformatProjection(zoom){
		if(zoom){		
			return function(element) {
				var projection = d3.geo.equirectangular()
					.center([zoom.x, zoom.y])
					.rotate([zoom.rx, zoom.ry])
					.scale(zoom.scale)
					.translate([element.offsetWidth / 2, element.offsetHeight / 2]);
				var path = d3.geo.path()
					.projection(projection);
				return {path: path, projection: projection};
			}
		}else return null;
	}
	
	Polymer('d3-datamaps', {
		d3map: null,
		hover: null,
		data: null,
		map: 'world',
		multiselect: false,
		theme: {
			defaultFill: defaultTheme.defaultFill,
			backgroundColor: defaultTheme.backgroundColor,
			borderWidth: defaultTheme.borderWidth,
            borderColor: defaultTheme.borderColor,
            highlightFillColor: defaultTheme.highlightFullColor,
            highlightBorderColor: defaultTheme.highlightBorderColor,
            highlightBorderWidth: defaultTheme.highlighBorderWidth,
			cursor: defaultTheme.cursor
		},
		attached: function(){
			var self = this;
			
			//fill parent element
			if(this.clientWidth>0){
				var height = this.clientHeight;
				if(height < 64){
					if(self.map=='world') height = this.clientWidth * 0.43;
					else if(self.map=='usa') height = this.clientWidth * 0.465;
				}
				this.$.container.style.height = height + 'px';
			}
			
			//zoom
			var projection = reformatProjection(this.zoom);
			
			//theme
			this.$.container.style.backgroundColor = this.theme.backgroundColor || defaultTheme.backgroundColor;
			this.$.container.style.cursor = this.theme.cursor || defaultTheme.cursor;
			
			this.d3map = new Datamap({
				element: this.$.container,
				scope: self.map,
				fills: {
					defaultFill: self.theme.defaultFill
				},
				data: self.data || {},
				setProjection: projection,
				geographyConfig: {
					dataUrl: '../src/js/datamaps/' + self.map + '.topo.json', //if not null, datamaps will fetch the map JSON (currently only supports topojson)
					hideAntarctica: false,
					borderWidth: self.theme.borderWidth || defaultTheme.borderWidth,
					borderColor: self.theme.borderColor || defaultTheme.borderColor,
					popupTemplate: function(geography, data) { //this function should just return a string
						if(!self.hover || self.hover.geography.id != geography.id) self.hover = { geography: geography, data: data };
						//if(c.indexOf(geography.id)>-1){
						var d = ''; //data.statehood;
						if(data && data.statehood) d = ' ' + data.statehood;
						return '<div class="hoverinfo"><strong>' + geography.properties.name + '</strong>' + d + '</div>';
						//}else{
						//  return '';
						//}
					},
					popupOffHover: function(){
						self.hover = null;
					},
					popupOnHover: true, //disable the popup while hovering
					highlightOnHover: true,
					highlightFillColor: self.theme.highlightFillColor || defaultTheme.highlightFillColor,
					highlightBorderColor: self.theme.highlightBorderColor || defaultTheme.highlightBorderColor,
					highlightBorderWidth: self.theme.highlightBorderWidth || defaultTheme.highlighBorderWidth
				},
				done: function(datamap) {
					var subunits = datamap.svg.selectAll('.datamaps-subunit');
					subunits.on('click', function(geography) {
						self.itemClicked(geography);
					});
				}
			});
		},
		itemClicked: function(geography){
			var data = {};
			//find record
			var d = this.data;
			for (var key in d) {
				if (d.hasOwnProperty(key) && key == geography.id) {
					data = d[key]
					break;
				}
			}
			this.fire('clicked', { geography: geography, data: data });

			if(this.multiselect){
				var color = this.theme.highlightFillColor || defaultTheme.highlightFillColor;
				var s = this.selected || {};
				var n = {};

				if(!s[geography.id]) n[geography.id] = color;

				for (var key in s) {
					if (s.hasOwnProperty(key) && key!=geography.id){
						n[key] = color;
					}
				}
				this.selected = n;
			}
		},
		selectedChanged: function(oldVal, newVal) {
			var cleared = this.theme.defaultFill;
			var selectedToFill = {};

			//clear old
			if(oldVal){
				for (var key in oldVal) {
					if (oldVal.hasOwnProperty(key)) {
						//check if it's in data
						var data;
						if(this.data) data = this.data[key];
						if(data){
							data.color = cleared;
							selectedToFill[key] = data;
						}else{
							oldVal.color = cleared;
							selectedToFill[key] = oldVal;
						}
					}
				}
			}

			//fill new
			if(newVal){
				for (var key in newVal) {
					if (newVal.hasOwnProperty(key)) {
						if(typeof newVal[key] === 'string'){
							selectedToFill[key] = { color: newVal[key] };
						}else{
							selectedToFill[key] = newVal[key];
						}
					}
				}
			}

			if(this.d3map) this.d3map.updateChoropleth(selectedToFill);
		},
		observe: {
			'zoom.x': 'zoomChanged',
			'zoom.y': 'zoomChanged',
			'zoom.rx': 'zoomChanged',
			'zoom.ry': 'zoomChanged',
			'zoom.scale': 'zoomChanged'
		},
		zoomChanged: function(oldVal, newVal){
			
			console.log('zoom');
			
			if(this.d3map){
			
				var svg = this.d3map.options.element.querySelector('svg');
				//var old = svg.childNodes.splice();
				while (svg.firstChild) {
					svg.removeChild(svg.firstChild);
				}
				
				var projection = reformatProjection(this.zoom);
				/*
				var projection = function(element) {
					var projection = d3.geo.equirectangular()
						.center([23, 5])
						.rotate([4.4, 0])
						.scale(400)
						.translate([element.offsetWidth / 2, element.offsetHeight / 2]);
					var path = d3.geo.path()
						.projection(projection);
					return {path: path, projection: projection};
				}
				*/
				this.d3map.options.setProjection = projection;

				
				var d = this.d3map.draw();
				//console.log('draw')				
			//	console.log(d);
			}
		}
	});
  </script>    
</polymer-element>