<!--
 https://github.com/stevenrskelton/d3-datamaps
-->

<script src="js/d3/d3.v3.min.js"></script>
<script src="js/topojson/topojson.v1.min.js"></script>
<script src="js/datamaps/datamaps.js"></script>

<polymer-element name="d3-datamaps" attributes="selected data hover clicked map theme">
  <template>
	<style>
		:host { display: block; }
	</style>
    <div id="container" style="vertical-align:top;position:relative;"></div>
  </template>
  <script>
	//https://github.com/markmarkoh/datamaps/blob/master/README.md#getting-started
	var defaultTheme = {
		defaultFill: '#ABDDA4',
		backgroundColor: '#56A5EC',
		borderWidth: 1,
		borderColor: '#FDFDFD',
		highlightFillColor: '#FC8D59',
		highlightBorderColor: 'rgba(250, 15, 160, 0.2)',
		highlightBorderWidth: 2,
		cursor: 'pointer'
	};
	
	Polymer('d3-datamaps', {
		d3map: null,
		hover: null,
		data: null,
		map: 'world',
		theme: {
			defaultFill: defaultTheme.defaultFill,
			backgroundColor: defaultTheme.backgroundColor,
			borderWidth: defaultTheme.borderWidth,
            borderColor: defaultTheme.borderColor,
            highlightFillColor: defaultTheme.highlightFullColor,
            highlightBorderColor: defaultTheme.highlightBorderColor,
            highlightBorderWidth: defaultTheme.highlighBorderWidth,
			cursor: defaultTheme.cursor
		},
		themeChanged: function(){
			//fill in defaults
			for (var key in defaultTheme) {
				if (defaultTheme.hasOwnProperty(key) && !this.theme.hasOwnProperty(key)) {
					this.theme[key] = defaultTheme[key];
				}
			}
		},
		ready: function(){
		console.log('clientwidth: ' + this.clientWidth);
		console.log('scrollwidth: ' + this.scrollWidth);
		},
		attached: function(){
			var self = this;
			
			//fill parent element
			if(this.clientWidth>0){
				var height = this.clientHeight;
				if(height < 64){
					if(self.map=='world') height = this.clientWidth * 0.47;
					else if(self.map=='usa') height = this.clientWidth * 0.47;
				}
				this.$.container.style.height = height + 'px';
			}
			
			//theme
			this.$.container.style.backgroundColor = this.theme.backgroundColor;
			this.$.container.style.cursor = this.theme.cursor;
			
			this.d3map = new Datamap({element: this.$.container,
				scope: self.map,
				fills: {
					defaultFill: self.theme.defaultFill
				},
				data: self.data || {},
				geographyConfig: {
					dataUrl: '../src/js/datamaps/' + self.map + '.topo.json', //if not null, datamaps will fetch the map JSON (currently only supports topojson)
					hideAntarctica: false,
					borderWidth: self.theme.borderWidth,
					borderColor: self.theme.borderColor,
					popupTemplate: function(geography, data) { //this function should just return a string
						if(!self.hover || self.hover.geography.id != geography.id) self.hover = { geography: geography, data: data };
						//if(c.indexOf(geography.id)>-1){
						var d = ''; //data.statehood;
						if(data && data.statehood) d = ' ' + data.statehood;
						return '<div class="hoverinfo"><strong>' + geography.properties.name + '</strong>' + d + '</div>';
						//}else{
						//  return '';
						//}
					},
					popupOffHover: function(){
						self.hover = null;
					},
					popupOnHover: true, //disable the popup while hovering
					highlightOnHover: true,
					highlightFillColor: self.theme.highlightFillColor,
					highlightBorderColor: self.theme.highlightBorderColor,
					highlightBorderWidth: self.theme.highlightBorderWidth
				},
				done: function(datamap) {
					var subunits = datamap.svg.selectAll('.datamaps-subunit');
					subunits.on('click', function(geography) {
						self.itemClicked(geography);
					});
				}
			});
		},
		itemClicked: function(geography){
			var data = {};
			//find record
			var d = this.data;
			for (var key in d) {
				if (d.hasOwnProperty(key) && key == geography.id) {
					data = d[key]
					break;
				}
			}
			this.fire('clicked', { geography: geography, data: data });
		},
		selectedChanged: function(oldVal, newVal) {
			var cleared = this.theme.defaultFill;
			var selectedToFill = {};

			//clear old
			if(oldVal){
				for (var key in oldVal) {
					if (oldVal.hasOwnProperty(key)) {
						oldVal.color = cleared;
						selectedToFill[key] = oldVal;
					}
				}
			}

			//fill new
			if(newVal){
				for (var key in newVal) {
					if (newVal.hasOwnProperty(key)) {
						if(typeof newVal[key] === 'string'){
							selectedToFill[key] = { color: newVal[key] };
						}else{
							selectedToFill[key] = newVal[key];
						}
					}
				}
			}
			if(this.d3map) this.d3map.updateChoropleth(selectedToFill);
		}
	});
  </script>    
</polymer-element>