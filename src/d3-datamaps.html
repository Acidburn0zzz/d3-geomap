<!--
 https://github.com/stevenrskelton/d3-datamaps
-->

<script src="js/d3/d3.v3.min.js"></script>
<script src="js/topojson/topojson.v1.min.js"></script>
<script src="js/datamaps/datamaps.js"></script>

<polymer-element name="d3-datamaps" attributes="selected data hover clicked map">
  <template>
    <style>
      #container {
		position:relative;
		background-color: #56A5EC;
      }
    </style>
    <div id="container" style="cursor:crosshair;"></div>
  </template>
  <script>
	//https://github.com/markmarkoh/datamaps/blob/master/README.md#getting-started
	Polymer('d3-datamaps', {
		d3map: null,
		width: 425,
		hover: null,
		map: 'world',
		data: null,
		attached: function(){
			var self = this;
			this.$.container.style.height = (this.$.container.scrollWidth*0.5) + 'px';
			this.d3map = new Datamap({element: this.$.container,
				scope: self.map,
				fills: {
					defaultFill: '#ABDDA4'
				},
				data: self.data || {},
				geographyConfig: {
					dataUrl: '../src/js/datamaps/' + self.map + '.topo.json', //if not null, datamaps will fetch the map JSON (currently only supports topojson)
					//hideAntarctica: false,
					borderWidth: 1,
					borderColor: '#99C68E',
					popupTemplate: function(geography, data) { //this function should just return a string
						if(!self.hover || self.hover.geography.id != geography.id) self.hover = { geography: geography, data: data };
						//if(c.indexOf(geography.id)>-1){
						var d = ''; //data.statehood;
						if(data && data.statehood) d = ' ' + data.statehood;
						return '<div class="hoverinfo"><strong>' + geography.properties.name + '</strong>' + d + '</div>';
						//}else{
						//  return '';
						//}
					},
					popupOffHover: function(){
						self.hover = null;
					},
					popupOnHover: true, //disable the popup while hovering
					highlightOnHover: true,
					highlightFillColor: '#F0F033',
					highlightBorderColor: '#DDDD33',
					highlightBorderWidth: 1
				},
				done: function(datamap) {
					var subunits = datamap.svg.selectAll('.datamaps-subunit');
					subunits.on('click', function(geography) {
						self.itemClicked(geography);
					});
				}
			});
		},
		itemClicked: function(geography){
			var data = {};
			//find record
			var d = this.data;
			for (var key in d) {
				if (d.hasOwnProperty(key) && key == geography.id) {
					data = d[key]
					break;
				}
			}
			this.fire('clicked', { geography: geography, data: data });
		},
		selectedChanged: function(oldVal, newVal) {
			var cleared = '#ABDDA4';
			var selectedToFill = {};

			//clear old
			if(oldVal){
				for (var key in oldVal) {
					if (oldVal.hasOwnProperty(key)) {
						oldVal.color = cleared;
						selectedToFill[key] = oldVal;
					}
				}
			}

			//fill new
			if(newVal){
				for (var key in newVal) {
					if (newVal.hasOwnProperty(key)) {
						if(typeof newVal[key] === 'string'){
							selectedToFill[key] = { color: newVal[key] };
						}else{
							selectedToFill[key] = newVal[key];
						}
					}
				}
			}
			if(this.d3map) this.d3map.updateChoropleth(selectedToFill);
		}
	});
  </script>    
</polymer-element>